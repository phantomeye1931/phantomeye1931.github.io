---

---

<div class="bg-grid bg-wrapper" aria-hidden="true">
    <pre class="font-trypewriter bg text-grid"></pre>
</div>

<script>
    const SCALE = 0.2; // UV scalar
    const SPEED = 0.15; // Time scalar

    // rotation matrix helper
    export function rotate(p: [number, number], angle: number): [number, number] {
        const c = Math.cos(angle), s = Math.sin(angle);
        return [c * p[0] - s * p[1], s * p[0] + c * p[1]];
    }

    // simple noise
    export function noise(p: [number, number], time: number): number {
        return Math.sin(p[0] * 10) * Math.sin(p[1] * (3 + Math.sin(time / 11))) + 0.2;
    }

    // fractional Brownian motion
    export function fbm(p: [number, number], time: number): number {
        let f = 0;
        let amp = 0.5;
        for (let i = 0; i < 3; i++) {
            const modify = rotate(p, (time / 50) * i * i);
            f += amp * noise(p, time);
            p = [modify[0] * 2, modify[1] * 2];
            amp /= 2.2;
        }
        return f;
    }

    // pattern function
    export function pattern(p: [number, number], time: number): number {
        const q: [number, number] = [
            fbm([p[0] + 1, p[1] + 1], time),
            fbm(rotate(p, 0.1 * time).map(v => v + 1) as [number, number], time),
        ];
        const r: [number, number] = [
            fbm(rotate(q, 0.1), time),
            fbm(q, time),
        ];
        return fbm([p[0] + r[0], p[1] + r[1]], time);
    }

    function gradient(a: number) {
        const out = 1 - a;
        return Math.min(Math.max(0, out), 1); // Clamp between 0 and 1
    }

    // generate a 2D noise grid
    export function genNoiseGrid(rows: number, cols: number, time: number, wearOff: boolean): number[][] {
        return Array.from({ length: rows }, (_, r) =>
            Array.from({ length: cols }, (_, c) => {
                const uv: [number, number] = [c / cols * SCALE, r / cols * SCALE]; // Both divided by cols to keep an 1:1 aspect ratio
                return pattern(uv, time * SPEED) * (wearOff ? gradient(c / cols) : 1);
            })
        );
    }

    const $thisElement = $(".bg-wrapper");
    const $asciiGrid = $(".text-grid");

    document.addEventListener('DOMContentLoaded', () => {

        if (!$thisElement.length || !$asciiGrid.length) return;

        let width = 0;
        let height = 0;

        function measureCharWidth(fontSize: number) {
            const span = document.createElement('span');
            // Use your available font
            span.style.fontFamily = 'monospace';
            span.textContent = 'M';
            span.style.position = 'absolute';
            span.style.visibility = 'hidden';
            span.style.fontSize = fontSize + 'px';
            span.style.lineHeight = '1';
            document.body.appendChild(span);
            const rect = span.getBoundingClientRect();
            document.body.removeChild(span);
            return rect.width || 6; // Fallback
        }

        const CHARS = ' .-=:*@@';
        function makeAsciiString(time: number) {
            const numericGrid = genNoiseGrid(height, width, time, true);
            let out = '';
            for (let r = 0; r < height; r++) {
                for (let c = 0; c < width; c++) {
                    const value = numericGrid?.[r]?.[c] ?? 0;
                    const charIndex = Math.floor(value * (CHARS.length - 1));
                    out += CHARS[Math.max(0, Math.min(CHARS.length - 1, charIndex))];
                }
                if (r < height - 1) out += '\n';
            }
            return out;
        }

        function setDimensions() {
            const fontSize = 10;
            const rect = $thisElement[0].getBoundingClientRect();
            const charWidth = measureCharWidth(fontSize);

            width = Math.floor(rect.width / charWidth);
            height = Math.floor(rect.height / fontSize);
        }

        function refreshCharacters() {
            $asciiGrid.text(makeAsciiString(Date.now() / 1000));
        }

        // Initialize
        setDimensions();
        refreshCharacters();

        // Handle Resize
        window.addEventListener('resize', () => {
            setDimensions();
            refreshCharacters();
        });

        setInterval(refreshCharacters, 125);
    });
</script>

<style>
.bg-grid {
    position: absolute;
    //inset: 0;
    width: 100%;
    min-height: 100vh;
    overflow: hidden;
    background-color: var(--col-background);
}

pre {
    display: block;
    position: absolute;
    margin: 0;
    color: var(--col-element);
    font-size: 20px;
    line-height: 1;
    min-height: 100%;
    letter-spacing: 0;
    white-space: pre;
    user-select: none;
}

.grid {
    z-index: -1;
    color: var(--col-element);
    pointer-events: none;
}

span.bg {
    background-color: var(--col-background);
}
</style>
