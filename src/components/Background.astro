---
interface Props {
    onlyLanding: boolean,
    wearOff: boolean,
}

const props = Astro.props;
---

<div class="bg-grid bg-wrapper" aria-hidden="true" only-landing={ props.onlyLanding } wear-off={ props.wearOff }  >
    <pre class="font-trypewriter bg text-grid"></pre>
</div>

<script>
    import init, {get_ascii_grid} from "../wasm";

    const $thisElement = $(".bg-wrapper");
    const $asciiGrid = $(".text-grid");

    document.addEventListener('DOMContentLoaded', async () => {
        await init();

        if (!$thisElement.length || !$asciiGrid.length) return;

        let width = 0;
        let height = 0;

        function measureCharWidth(fontSize: number) {
            const span = document.createElement('span');
            // Use your available font
            span.style.fontFamily = 'monospace';
            span.textContent = 'M';
            span.style.position = 'absolute';
            span.style.visibility = 'hidden';
            span.style.fontSize = fontSize + 'px';
            span.style.lineHeight = '1';
            document.body.appendChild(span);
            const rect = span.getBoundingClientRect();
            document.body.removeChild(span);
            return rect.width || 6; // Fallback
        }

        function setDimensions() {
            const fontSize = 20;
            const rect = $thisElement[0].getBoundingClientRect();
            const charWidth = measureCharWidth(fontSize);

            width = Math.floor(rect.width / charWidth);
            height = Math.floor(rect.height / fontSize);
        }

        const wearOff = $thisElement.attr('wear-off') === "true";

        function refreshCharacters() {
            const ascii = get_ascii_grid(wearOff, width, height, Date.now() / 1000);
            $asciiGrid.text(ascii);
        }

        // Initialize
        setDimensions();
        refreshCharacters();

        // Handle Resize
        window.addEventListener('resize', () => {
            setDimensions();
            refreshCharacters();
        });

        setInterval(refreshCharacters, 125);
    });
</script>

<style>
.bg-grid {
    position: absolute;
    inset: 0;
    width: 100%;
    min-height: 100svh;
    overflow: hidden;
    background-color: var(--col-background);

    &[only-landing="true"] {
        height: 100svh;
    }
}

pre {
    display: block;
    position: absolute;
    margin: 0;
    color: var(--col-element);
    font-size: 20px;
    line-height: 1;
    min-height: 100%;
    letter-spacing: 0;
    white-space: pre;
    user-select: none;
}

.grid {
    z-index: -1;
    color: var(--col-element);
    pointer-events: none;
}

span.bg {
    background-color: var(--col-background);
}
</style>
